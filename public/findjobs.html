<!DOCTYPE html>
<html lang="en" ng-app="JobApp" ng-controller="JobController">
<head>
  <meta charset="UTF-8">
  <title>Job Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  
  <!-- AngularJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.3/angular.min.js"></script>

  <style>
    body {
      background-color: #f8f9fa;
    }
    .job-card {
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    .apply-btn {
      background: linear-gradient(135deg, #4cafef, #007bff);
      color: white;
      border: none;
      padding: 8px;
      border-radius: 6px;
      transition: background 0.3s;
    }
    .apply-btn:hover {
      background: linear-gradient(135deg, #007bff, #0056b3);
    }
  </style>
</head>
<body>

<div class="container py-4">
  <h2 class="text-center mb-4">Available Jobs</h2>

  <!-- Filters -->
  <div class="row mb-3">
    <div class="col-md-3 mb-2">
      <input type="text" ng-model="filters.city" class="form-control" placeholder="Filter by City" ng-keypress="$event.which===13 && fetchJobs()">
    </div>
    <div class="col-md-3 mb-2">
      <input type="text" ng-model="filters.jobtitle" class="form-control" placeholder="Filter by Job Title" ng-keypress="$event.which===13 && fetchJobs()">
    </div>
    <div class="col-md-3 mb-2">
      <div>
        <label class="me-2"><input type="radio" ng-model="filters.education" value="" ng-change="fetchJobs()"> All</label>
        <label class="me-2"><input type="radio" ng-model="filters.education" value="true" ng-change="fetchJobs()"> Education Yes</label>
        <label><input type="radio" ng-model="filters.education" value="false" ng-change="fetchJobs()"> Education No</label>
      </div>
    </div>
    <div class="col-md-3 mb-2 text-end">
      <button class="btn btn-success" ng-click="fetchJobs()">Search</button>
    </div>
  </div>

  <!-- Jobs list -->
  <div class="row" ng-if="jobs.length > 0">
    <div class="col-md-6 col-lg-4 mb-4" ng-repeat="job in jobs">
      <div class="card job-card h-100">
        <div class="card-body">
          <h5 class="card-title">{{job.jobtitle || 'No Title'}}</h5>
          <h6 class="card-subtitle mb-2">{{job.city ? 'City: ' + job.city : ''}}</h6>
          <ul class="list-group list-group-flush mb-2">
            <li class="list-group-item"><b>Education:</b> {{job.education ? 'Yes' : 'No'}}</li>
            <li class="list-group-item"><b>Firm:</b> {{job.firmaddress || 'N/A'}}</li>
            <li class="list-group-item"><b>Contact:</b> {{job.contactperson || 'N/A'}}</li>
          </ul>
          <button class="apply-btn w-100" ng-click="applyForJob(job.id)">Apply</button>
        </div>
      </div>
    </div>
  </div>

  <!-- No jobs found -->
  <div class="alert alert-warning text-center" ng-if="jobs.length === 0 && !loading && !errorMsg">
    No jobs found for the selected filters.
  </div>

  <!-- Error message -->
  <div class="alert alert-danger text-center" ng-if="errorMsg">
    {{errorMsg}}
  </div>

</div>

<script>
angular.module('JobApp', [])
.controller('JobController', function($scope, $http) {
  $scope.jobs = [];
  $scope.errorMsg = '';
  $scope.loading = false;

  $scope.filters = {
    city: '',
    jobtitle: '',
    education: ''
  };

  $scope.fetchJobs = function() {
    $scope.loading = true;
    $scope.errorMsg = '';
    
    let params = {};
    if ($scope.filters.city) params.city = $scope.filters.city;
    if ($scope.filters.jobtitle) params.jobtitle = $scope.filters.jobtitle;
    if ($scope.filters.education) params.education = $scope.filters.education;

    $http({
      method: 'GET',
      url: '/all-jobs',
      params: params
    }).then(function(res) {
      $scope.jobs = res.data || [];
    }).catch(function() {
      $scope.errorMsg = 'Error fetching jobs.';
    }).finally(function() {
      $scope.loading = false;
    });
  };

  $scope.applyForJob = function(jobid) {
    // Volunteer applies on behalf (their details will be saved)
    var volunteerEmail = sessionStorage.getItem('loggedInEmail') || '';
    if (!volunteerEmail) {
      alert('Please login as a volunteer to apply.');
      return;
    }

    $http.post('/apply-job', {
      jobid: jobid,
      volunteer_email: volunteerEmail
    }).then(function(res) {
      alert((res.data && res.data.message) || 'Applied successfully!');
    }).catch(function(err) {
      if (err.status === 409) {
        alert('You have already applied for this job.');
      } else if (err.data && err.data.error) {
        alert(err.data.error);
      } else {
        alert('Could not apply. Please try again.');
      }
    });
  };

  // Load all jobs on page load
  $scope.fetchJobs();
});
</script>

</body>
</html>
